@code {
    [Parameter, EditorRequired] public string Username { get; init; } = null!;
    [Parameter, EditorRequired] public string Password { get; init; } = null!;
    [Parameter] public RenderFragment? ChildContent { get; init; }
    [Parameter] public string Realm { get; init; } = "AuthRealm";
    [Inject] public IHttpContextAccessor accessor { get; init; } = default!;
    [Inject] public NavigationManager Navigation { get; init; } = default!;
    private HttpContext Context => accessor.HttpContext!;
    private bool _isAuthenticated;
    private bool IsAuthenticated
    {
        get
        {
            if (!_isAuthenticated)
            {
                _ = bool.TryParse(Context.Session.GetString($"{Realm}-IsAuthenticated"), out bool result);
                if (result) _isAuthenticated = true;
            }
            return _isAuthenticated;
        }
        set {
            if (value) Context.Session.SetString($"{Realm}-IsAuthenticated", "true");
            else Context.Session.Remove($"{Realm}-IsAuthenticated");
            _isAuthenticated = value;
        }
    }

    // A secure session identifier for the realm
    private string SecureArea
    {
        get
        {
            if (String.IsNullOrEmpty(Context.Session.GetString(Realm)))
                Context.Session.SetString(Realm, $"Secure-Area-{Guid.NewGuid()}");
            return (Context.Session.GetString(Realm)!);
        }
    }

    protected override void OnInitialized()
    {
        if (accessor?.HttpContext == null)
            throw new NullReferenceException($"{nameof(accessor)} service missing!");

        if (String.IsNullOrEmpty(Username) || String.IsNullOrEmpty(Password))
            throw new ArgumentNullException($"{nameof(Username)} or {nameof(Password)} cannot be NULL!");

        Authenticate();
    }

    // Authenticate the user based on the Authorization header
    private void Authenticate()
    {
        // If no Authorization header, force login
        if (!Context.Request.Headers.ContainsKey("Authorization"))
        {
            RequestAuthentication();
            return;
        }

        var credentials = ParseAuthorizationHeader(Context.Request.Headers["Authorization"].ToString());

        if (credentials == null || !ValidateUser(credentials.Value.username, credentials.Value.password))
        {
            RequestAuthentication();
            return;
        }

        // Set the user as authenticated securely in the session
        IsAuthenticated = true;

        StateHasChanged();
    }

    // Method to trigger a login prompt
    private void RequestAuthentication()
    {
        if (!Context.Response.HasStarted)
        {
            // Use the session-stored realm, forcing login when needed
            Context.Response.Headers["WWW-Authenticate"] = $"Basic realm=\"{SecureArea}\"";
            Context.Response.StatusCode = 401;  // Unauthorized
        }
    }

    // Parse the Basic Authorization header
    private (string username, string password)? ParseAuthorizationHeader(string authHeader)
    {
        if (!authHeader.StartsWith("Basic ", StringComparison.OrdinalIgnoreCase)) return null;

        var encodedCredentials = authHeader["Basic ".Length..].Trim();
        var credentialBytes = Convert.FromBase64String(encodedCredentials);
        var credentials = System.Text.Encoding.UTF8.GetString(credentialBytes).Split(':', 2);

        return credentials.Length == 2 ? (credentials[0], credentials[1]) : null;
    }

    // Logout method to clear the session and headers
    private void Logout()
    {
        // Clear the session data and reset the private boolean

        Context.Session.Clear();

        IsAuthenticated = false;

        Context.Request.Headers.Clear();

        StateHasChanged();
    }

    // Validate the provided username and password
    private bool ValidateUser(string username, string password) =>
        String.Equals(username, this.Username, StringComparison.Ordinal) &&
        String.Equals(password, this.Password, StringComparison.Ordinal);
}

@if (IsAuthenticated)
{
    @ChildContent
}
else
{
    <h1 class="d-flex justify-content-center align-items-center mt-5">401 Unauthorized - Authentication Required</h1>
}
